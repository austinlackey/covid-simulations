---
title: "Predicting Covid Data"
author: "Austin Lackey, Chien Lin and Jin Peng"
date: "Tuesday, November 6th, 2022"
output:
  powerpoint_presentation: default
  beamer_presentation: default
---

```{r, results=FALSE, echo=FALSE, message=FALSE, warning=FALSE}
# useful libraries
library(tidyverse)
library(dplyr)
library(ggplot2)
library(pracma)
library(minpack.lm)
# read covid data
data <- read_csv("owid-covid-data.csv")
knitr::opts_chunk$set(fig.width=12, fig.height=8) 
```


## The Monte Carlo Study: 

**Mathematical prediction of the time evolution of the COVID-19 pandemic in Italy by a Gauss error function and Monte Carlo simulations**


<br>

*Author: Ignazio Ciufolini, Antonio Paolozzi*


## Introduction : Ciufolini and Paolozzi's Study

* In this study by Ignazio Ciufolini and Antonio Paolozzi, they use a Gauss Error function that approximates the distribution of the cumulative positive cases of COVID-19 in China
  * They have then use the function to approximate the number of cumulative positive cases in Italy
  * Then performed a 150 Monte Carlo simulations to predict the peak and valley of the number of daily positive cases and fatalities
* This study do not take into account factors such as daily nasopharyngeal swabs, medical, social distancing, etc. 

## Cont.

* The number of cumulative diagnosed positive cases and fatalities in China approximates a gauss error function: $a+b*erf(c*x-d)$.
* Predicted the potential number of cases in Italy.
* Predicted the day in which the peak of the number of daily cases in Italy occurs.


## Overview of the Monte Carlo Simulation

* create a random matrix : m X n
  * m = number of random outcomes (*chosen to be 150*)
  * n = number of observed days (*n = 1,...,j*)
* each # in the matrix is a Gaussian distribution with mean = 1 and sigma = 0.1
  * multiply each column (*j*) by the # of total cases (or deaths) that corresponds to each day *j* **#FIXME#**
- add more...


# China Simulation

## Available Official Data (Positive Cases)

```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.show="hold", out.width="50%"}
# extract China data of interest
china <- data |>
  filter(location == "China") |>
  filter(date >= "2020-01-22", date <= "2020-03-28") |>
  select(c(date, total_cases, total_deaths)) |>
  mutate(days = 1:n())

# recreate plots
positive <- ggplot(data = china) +
  geom_point(aes(x = date, y = total_cases), color = "red") +
  labs(x = "Date", y = "China cumulative number of cases")
positive
```

## Available Official Data (Fatalities)

```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.show="hold", out.width="50%"}
ggplot(data = china) +
  geom_point(aes(x = date, y = total_deaths), color = "red") +
  labs(x = "Date", y = "China cumulative number of fatalities") +
  ylim(0,5000)
```

## Fit by the Gauss Error Function

Apply $nls$ function to determine the nonlinear (weighted) least-squares estimates of the four parameters $a,b,c,d$ of a Gauss error function model: $a+b*erf(c*x-d)$.

```{r, include=FALSE, message=FALSE, warning=FALSE}
gauss_fn <- function(x,a,b,c,d) {a+b*erf(c*x-d)}
```

```{r, message=FALSE, warning=FALSE}
model <- nls(total_cases ~ gauss_fn(days,a,b,c,d), 
             data=china, 
             start=list(a=10000,b=10000,c=0.1,d=1))
```

## Fit by the Gauss Error Function and Peak Day (Positive Cases)

```{r, results=FALSE, echo=FALSE, message=FALSE, warning=FALSE}
try <- china$total_cases
model_try <- nls(try ~ gauss_fn(days,a,b,c,d), data=china, start=list(a=2200,b=2200,c=0.1,d=1))
est_try <- summary(model_try)$parameters
est_try <- est_try[, 1]
names(est_try) <- NULL
fn_try <- function(x, ests) {ests[1]  + ests[2] * erf(ests[3] * x - ests[4])}

# find the second derivative of fitted function
# source: https://proofwiki.org/wiki/Derivative_of_Error_Function
erf_deriv <- function(x) {2/sqrt(pi)*exp(-x^2)}
fn_try_deriv <- bquote(.(est_try[2]) * 2/sqrt(pi) * exp(-(.(est_try[3]) * x - .(est_try[4]))^2))
fn_try_deriv <- D(fn_try_deriv,'x')
x=seq(1,67,length.out=6700)
tmp <- eval(fn_try_deriv)
peak1 <- min(x[tmp < 0])
```

```{r, results=FALSE, echo=FALSE, message=FALSE, warning=FALSE}
gauss_fn <- function(x,a,b,c,d) {a+b*erf(c*x-d)}
model1 <- nls(total_cases ~ gauss_fn(days,a,b,c,d), data=china, start=list(a=10000,b=10000,c=0.1,d=1))
# summary(model1)$parameters
fn_model1 <- function(x) {4.017e+04 + 4.047e+04 * erf(9.284e-02 * x - 1.732e+00)}
ggplot(data = china) +
  geom_point(aes(x = days, y = total_cases), color = "red") +
  labs(x = "Days", y = "China cumulative number of cases") +
  stat_function(fun=fn_model1) +
  geom_segment(aes(x = peak1, y = 0, xend = peak1, yend = china$total_cases[ceiling(peak1)]), color="blue")
```

## Fit by the Gauss Error Function and Peak Day (Fatalities)

```{r, results=FALSE, echo=FALSE, message=FALSE, warning=FALSE}
try <- china$total_deaths
model_try <- nls(try ~ gauss_fn(days,a,b,c,d), data=china, start=list(a=2200,b=2200,c=0.1,d=1))
est_try <- summary(model_try)$parameters
est_try <- est_try[, 1]
names(est_try) <- NULL
fn_try <- function(x, ests) {ests[1]  + ests[2] * erf(ests[3] * x - ests[4])}

# find the second derivative of fitted function
# source: https://proofwiki.org/wiki/Derivative_of_Error_Function
erf_deriv <- function(x) {2/sqrt(pi)*exp(-x^2)}
fn_try_deriv <- bquote(.(est_try[2]) * 2/sqrt(pi) * exp(-(.(est_try[3]) * x - .(est_try[4]))^2))
fn_try_deriv <- D(fn_try_deriv,'x')
x=seq(1,67,length.out=6700)
tmp <- eval(fn_try_deriv)
peak2 <- min(x[tmp < 0])
```

```{r, results=FALSE, echo=FALSE, message=FALSE, warning=FALSE}
model2 <- nls(total_deaths ~ gauss_fn(days,a,b,c,d), data=china, start=list(a=10000,b=10000,c=0.1,d=1))
#summary(model2)$parameters
fn_model2 <- function(x) {1.571e+03 + 1.658e+03 * erf(6.194e-02 * x - 1.533e+00)}
ggplot(data = china) +
  geom_point(aes(x = days, y = total_deaths), color = "red") +
  labs(x = "Days", y = "China cumulative number of fatalities") +
  ylim(0,5000) +
  stat_function(fun=fn_model2) +
  geom_segment(aes(x = peak2, y = 0, xend = peak2, yend = china$total_deaths[ceiling(peak2)]), color="blue")
```

# Italy Simulation

## Plot of Diagnosed Positive Cases

```{r, echo=FALSE, message=FALSE, warning=FALSE}
# extract Italy data
italy <- data %>% 
  filter(location=="Italy") %>% 
  filter(date <= "2020-04-21") %>%
  filter(date >= "2020-02-15") %>%
  select(date, total_cases, total_deaths) %>% 
  mutate(days = c(1:67))
italy[45:67,] <- NA


ggplot() +
  geom_point(aes(x = date, y = total_cases), data = italy)
#+ geom_smooth(aes(x = date, y = total_cases), data=italy)
```

## Plot of Fatalities

```{r, echo=FALSE, message=FALSE, warning=FALSE}
ggplot() +
  geom_point(aes(x = date, y = total_deaths), data = italy)
#+ geom_smooth(aes(x = date, y = total_deaths), data=italy)
```

## Plot of Diagnosed Positive Cases with Gauss Error Function

```{r, echo=FALSE, message=FALSE, warning=FALSE}
x <- 1:67
ggplot(italy,aes(x)) +
  geom_point(aes(x = days, y = total_cases)) +
  stat_function(fun=function(x) 100000 + 100000 * erf(0.07*x - 3))
```

## Plot of Fatalities with Gauss Error Function

```{r, echo=FALSE, message=FALSE, warning=FALSE}
ggplot(italy,aes(x)) +
  geom_point(aes(x = days, y = total_deaths)) +
  stat_function(fun=function(x) 11000 + 11000 * erf(0.068*x - 3))
```

# Australia Simulation

## Initial Data for Cases in Australia

```{r, results=FALSE, echo=FALSE, message=FALSE, warning=FALSE}
australia <- data %>% filter(location == "Australia", date > "2020-06-01", date < "2020-12-19")
australia <- subset(australia, select = c(date, total_cases, total_deaths))
australia <- australia %>% mutate(days = 1:n())
minimizedDays <- 70
australiaPre <- australia %>% filter(days < minimizedDays)
cases_Australia <- ggplot(australiaPre, aes(x = days, y = total_cases)) + 
    geom_point() + 
    labs(title = "Total Cases in Australia from 6/2/2020 to 8/9/2020 (70 days)", x = "Days", y = "Total Cases")
fatalities_Australia <- ggplot(australiaPre, aes(x = days, y = total_deaths)) +
    geom_point() + 
    labs(title = "Total Deaths in Australia from 6/2/2020 to 8/9/2020 (70 days)", x = "Days", y = "Total Deaths")
```

```{r, echo=FALSE, message=FALSE, warning=FALSE}
print(cases_Australia)
```

## Initial Data for Fatalities in Australia

```{r, echo=FALSE, message=FALSE, warning=FALSE}
print(fatalities_Australia)
```

## Fitting Gauss Error Function to Cases in Australia

```{r, results=FALSE, echo=FALSE, message=FALSE, warning=FALSE}
x <- 0:minimizedDays


gauss_fn <- function(x,a,b,c,d) {a+b*erf(c*x-d)}
cf <- summary(nlsLM(total_cases ~ gauss_fn(days,a,b,c,d), data=australia, start=list(a=10000,b=500,c=.02,d=1)))$parameters
ff <- summary(nlsLM(total_deaths ~ gauss_fn(days,a,b,c,d), data=australia, start=list(a=100,b=100,c=.01,d=1)))$parameters


cases_function_australia <- function(x) cf[1]+cf[2]*erf(cf[3]*x-cf[4])
fatalities_function_australia <- function(x) ff[1]+ff[2]*erf(ff[3]*x-ff[4])


cases_pre_plot_Australia <- ggplot(australiaPre, aes(x = days, y = total_cases)) + 
    geom_point() + 
    stat_function(fun=cases_function_australia, color="#d33636", size=2, linetype="solid") +
    scale_x_continuous(breaks = seq(0, minimizedDays, 10)) +
    labs(title = "Total Cases in Australia from 6/2/2020 to 8/9/2020 (70 days)", x = "Days", y = "Total Cases")
fatalities_pre_plot_Australia <- ggplot(australiaPre, aes(x = days, y = total_deaths)) +
    geom_point() + 
    stat_function(fun=fatalities_function_australia, color="#1b95ff", size=2, linetype="solid") +
    scale_x_continuous(breaks = seq(0, minimizedDays, 10)) +
    labs(title = "Total Deaths in Australia from 6/2/2020 to 8/9/2020 (70 days)", x = "Days", y = "Total Deaths")
```

```{r, echo=FALSE, message=FALSE, warning=FALSE}
print(cases_pre_plot_Australia)
```

## Fitting Gauss Error Function to Fatalities in Australia

```{r, echo=FALSE, message=FALSE, warning=FALSE}
print(fatalities_pre_plot_Australia)
```

## Applying the function to the whole cases dataset

```{r, results=FALSE, echo=FALSE, message=FALSE, warning=FALSE}
x <- 0:200

# cases_function_australia <- function(x) 17200+10000*erf(0.04*x-2.4)
# fatalities_function_australia <- function(x) 500+400*erf(0.038*x-3.1)

cases_plot_Australia <- ggplot(australia, aes(x = days, y = total_cases)) + 
    geom_point() + 
    stat_function(fun=cases_function_australia, color="#d33636", size=1.5) +
    scale_x_continuous(breaks = seq(0, 200, 10)) +
    labs(title = "Total Cases in Australia from 6/2/2020 to 12/18/2020 (200 days)", x = "Days", y = "Total Cases")
fatalities_plot_Australia <- ggplot(australia, aes(x = days, y = total_deaths)) +
    geom_point() + 
    stat_function(fun=fatalities_function_australia, color="#1b95ff", size=1.5) +
    scale_x_continuous(breaks = seq(0, 200, 10)) +
    labs(title = "Total Deaths in Australia from 6/2/2020 to 12/18/2020 (200 days)", x = "Days", y = "Total Deaths")
```

```{r, echo=FALSE, message=FALSE, warning=FALSE}
print(cases_plot_Australia)
```

## Applying the function to the whole fatalities dataset

```{r, echo=FALSE, message=FALSE, warning=FALSE}
print(fatalities_plot_Australia)
```

## Using MonteCarlo Simulation to predict the day of flex

```{r, results=FALSE, echo=FALSE, message=FALSE, warning=FALSE}
#Montecarlo Simulation
set.seed(400)
n <- dim(australia)[1]
m <- 150
sigma <- 0.1
mu <- 1
gau_sample <- matrix(rnorm(n*m, mean=mu, sd=sigma), nrow = m, ncol = n)

mc_data_ca <- c()
for (i in 1:n) {
    mc_data_ca <- c(mc_data_ca, australia$total_cases[i]*gau_sample[,i])
}
mc_data_ca <- matrix(mc_data_ca, nrow = m, ncol = n)
mc_data_fa <- c()
for (i in 1:n) {
    mc_data_fa <- c(mc_data_fa, australia$total_deaths[i]*gau_sample[,i])
}
mc_data_fa <- matrix(mc_data_fa, nrow = m, ncol = n)

day_of_flex_ca <- rep(NA, m)
for (i in 1:m) {
    trial <- mc_data_ca[i,]
    trial_model <- nlsLM(trial ~ gauss_fn(days,a,b,c,d), data=australia, start=list(a=15000,b=9000,c=.01,d=1))
    model_coef <- summary(trial_model)$parameters[, 1]
    # trial_function <- function(x, coef) {coef[1] + coef[2]*erf(coef[3]*x-coef[4])}
    gauserr_derivative <- {2/sqrt(pi)*exp(-x^2)}
    function_trial_derivative <- D(bquote(.(model_coef[2])*2/sqrt(pi)*exp(-(.(model_coef[3])*x-.(model_coef[4]))^2)), 'x')
    x = seq(1, 200, length.out=6700)
    temp <- eval(function_trial_derivative)
    day_of_flex_ca[i] <- min(x[temp < 0])
}
```

```{r, results=FALSE, echo=FALSE, message=FALSE, warning=FALSE}
day_of_flex_fa <- rep(NA, m)
for (i in 1:m) {
    trial <- mc_data_fa[i,]
    trial_model <- nlsLM(trial ~ gauss_fn(days,a,b,c,d), data=australia, start=list(a=300,b=200,c=.01,d=1))
    model_coef <- summary(trial_model)$parameters[, 1]
    # trial_function <- function(x, coef) {coef[1] + coef[2]*erf(coef[3]*x-coef[4])}
    gauserr_derivative <- {2/sqrt(pi)*exp(-x^2)}
    function_trial_derivative <- D(bquote(.(model_coef[2])*2/sqrt(pi)*exp(-(.(model_coef[3])*x-.(model_coef[4]))^2)), 'x')
    x = seq(1, 200, length.out=6700)
    temp <- eval(function_trial_derivative)
    day_of_flex_fa[i] <- min(x[temp < 0])
}
```

```{r, echo=FALSE, message=FALSE, warning=FALSE, results=FALSE}
print(mean(day_of_flex_fa))
print(sd(day_of_flex_fa))
print(mean(day_of_flex_ca))
print(sd(day_of_flex_ca))
```

- The mean of the day of flex for cases is 60.22 days and the standard deviation is 0.77 days.
- The mean of the day of flex for fatalities is 81.4 days and the standard deviation is 0.69 days.

## Applying the day of flex indicator to the data (Cases)

```{r, echo=FALSE, message=FALSE, warning=FALSE}
print(cases_plot_Australia + geom_vline(xintercept = mean(day_of_flex_ca), color="#d33636", size=1.5, linetype="dashed"))
```

## Applying the day of flex indicator to the data (Fatalities)

```{r, echo=FALSE, message=FALSE, warning=FALSE}
print(fatalities_plot_Australia + geom_vline(xintercept = mean(day_of_flex_fa), color="#1b95ff", size=1.5, linetype="dashed"))
```

## Works Cited
- Link to study:
- I. Ciufolini, A. Paolozzi, Prediction of the time evolution of the Covid-19 Pandemic in Italy by a Gauss
Error Function and Monte Carlo simulations. Submitted to BioRxiv on 03.26.2020 and transferred on
03.27.2020 to MedRxiv. https://doi.org/10.1101/2020.03.27.20045104
- Link to covid data:
- https://covid19.who.int/
- source to find the second derivative of fitted function:
- https://proofwiki.org/wiki/Derivative_of_Error_Function