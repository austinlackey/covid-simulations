---
title: "Predicting Covid Data"
author: "Austin Lackey, Chien Lin and Jin Peng"
date: "Tuesday, November 6th, 2022"
output:
  powerpoint_presentation: default
  beamer_presentation: default
---

```{r, results=FALSE, echo=FALSE, message=FALSE, warning=FALSE}
# useful libraries
library(tidyverse)
library(dplyr)
library(ggplot2)
library(pracma)
# read covid data
data <- read_csv("owid-covid-data.csv")
```

## The Monte Carlo Study: 

**Mathematical prediction of the time evolution of the COVID-19 pandemic in Italy by a Gauss error function and Monte Carlo simulations**

<br>

*Author: Ignazio Ciufolini, Antonio Paolozzi*


## Introduction : Ciufolini and Paolozzi's Study

* In this study by Ignazio Ciufolini and Antonio Paolozzi, they use a Gauss Error function that approximates the distribution of the cumulative positive cases of COVID-19 in China
  * They have then use the function to approximate the number of cumulative positive cases in Italy
  * Then performed a 150 Monte Carlo simulations to predict the peak and valley of the number of daily positive cases and fatalities
* This study do not take into account factors such as daily nasopharyngeal swabs, medical, social distancing, etc. 

## Cont.

* Mathematical prediction of the time evolution of the COVID-19 pandemic by a Gauss error function and Monte Carlo simulations:
  * The number of cumulative diagnosed positive cases and fatalities in China approximates a gauss error function: $a+b*erf(c*x-d)$.
  * Predicted the potential number of cases in Italy.
  * Predicted the day in which the peak of the number of daily cases in Italy occurs.


## Overview of the Monte Carlo Simulation

* create a random matrix : m X n
  * m = number of random outcomes (*chosen to be 150*)
  * n = number of observed days (*n = 1,...,j*)
* each # in the matrix is a Gaussian distribution with mean = 1 and sigma = 0.1
  * multiply each column (*j*) by the # of total cases (or deaths) that corresponds to each day *j* **#FIXME#**
- add more...


# China Simulation

## Available Official Data (Positive Cases)

```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.show="hold", out.width="50%"}
# extract China data of interest
china <- data |>
  filter(location == "China") |>
  filter(date >= "2020-01-22", date <= "2020-03-28") |>
  select(c(date, total_cases, total_deaths)) |>
  mutate(days = 1:n())

# recreate plots
positive <- ggplot(data = china) +
  geom_point(aes(x = date, y = total_cases), color = "red") +
  labs(x = "Date", y = "China cumulative number of cases")
positive
```

## Available Official Data (Fatalities)

```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.show="hold", out.width="50%"}
ggplot(data = china) +
  geom_point(aes(x = date, y = total_deaths), color = "red") +
  labs(x = "Date", y = "China cumulative number of fatalities") +
  ylim(0,5000)
```

## Fit by the Gauss Error Function

Apply $nls$ function to determine the nonlinear (weighted) least-squares estimates of the four parameters $a,b,c,d$ of a Gauss error function model: $a+b*erf(c*x-d)$.

```{r, include=FALSE, message=FALSE, warning=FALSE}
gauss_fn <- function(x,a,b,c,d) {a+b*erf(c*x-d)}
```

```{r, message=FALSE, warning=FALSE}
model <- nls(total_cases ~ gauss_fn(days,a,b,c,d), 
             data=china, 
             start=list(a=10000,b=10000,c=0.1,d=1))
```

## Fit by the Gauss Error Function and Peak Day (Positive Cases)

```{r, results=FALSE, echo=FALSE, message=FALSE, warning=FALSE}
try <- china$total_cases
model_try <- nls(try ~ gauss_fn(days,a,b,c,d), data=china, start=list(a=2200,b=2200,c=0.1,d=1))
est_try <- summary(model_try)$parameters
est_try <- est_try[, 1]
names(est_try) <- NULL
fn_try <- function(x, ests) {ests[1]  + ests[2] * erf(ests[3] * x - ests[4])}

# find the second derivative of fitted function
# source: https://proofwiki.org/wiki/Derivative_of_Error_Function
erf_deriv <- function(x) {2/sqrt(pi)*exp(-x^2)}
fn_try_deriv <- bquote(.(est_try[2]) * 2/sqrt(pi) * exp(-(.(est_try[3]) * x - .(est_try[4]))^2))
fn_try_deriv <- D(fn_try_deriv,'x')
x=seq(1,67,length.out=6700)
tmp <- eval(fn_try_deriv)
peak1 <- min(x[tmp < 0])
```

```{r, results=FALSE, echo=FALSE, message=FALSE, warning=FALSE}
gauss_fn <- function(x,a,b,c,d) {a+b*erf(c*x-d)}
model1 <- nls(total_cases ~ gauss_fn(days,a,b,c,d), data=china, start=list(a=10000,b=10000,c=0.1,d=1))
# summary(model1)$parameters
fn_model1 <- function(x) {4.017e+04 + 4.047e+04 * erf(9.284e-02 * x - 1.732e+00)}
ggplot(data = china) +
  geom_point(aes(x = days, y = total_cases), color = "red") +
  labs(x = "Days", y = "China cumulative number of cases") +
  stat_function(fun=fn_model1) +
  geom_segment(aes(x = peak1, y = 0, xend = peak1, yend = china$total_cases[ceiling(peak1)]), color="blue")
```

## Fit by the Gauss Error Function and Peak Day (Fatalities)

```{r, results=FALSE, echo=FALSE, message=FALSE, warning=FALSE}
try <- china$total_deaths
model_try <- nls(try ~ gauss_fn(days,a,b,c,d), data=china, start=list(a=2200,b=2200,c=0.1,d=1))
est_try <- summary(model_try)$parameters
est_try <- est_try[, 1]
names(est_try) <- NULL
fn_try <- function(x, ests) {ests[1]  + ests[2] * erf(ests[3] * x - ests[4])}

# find the second derivative of fitted function
# source: https://proofwiki.org/wiki/Derivative_of_Error_Function
erf_deriv <- function(x) {2/sqrt(pi)*exp(-x^2)}
fn_try_deriv <- bquote(.(est_try[2]) * 2/sqrt(pi) * exp(-(.(est_try[3]) * x - .(est_try[4]))^2))
fn_try_deriv <- D(fn_try_deriv,'x')
x=seq(1,67,length.out=6700)
tmp <- eval(fn_try_deriv)
peak2 <- min(x[tmp < 0])
```

```{r, results=FALSE, echo=FALSE, message=FALSE, warning=FALSE}
model2 <- nls(total_deaths ~ gauss_fn(days,a,b,c,d), data=china, start=list(a=10000,b=10000,c=0.1,d=1))
#summary(model2)$parameters
fn_model2 <- function(x) {1.571e+03 + 1.658e+03 * erf(6.194e-02 * x - 1.533e+00)}
ggplot(data = china) +
  geom_point(aes(x = days, y = total_deaths), color = "red") +
  labs(x = "Days", y = "China cumulative number of fatalities") +
  ylim(0,5000) +
  stat_function(fun=fn_model2) +
  geom_segment(aes(x = peak2, y = 0, xend = peak2, yend = china$total_deaths[ceiling(peak2)]), color="blue")
```

# Italy Simulation

## Plot of Diagnosed Positive Cases

```{r, echo=FALSE, message=FALSE, warning=FALSE}
# extract Italy data
italy <- data %>% 
  filter(location=="Italy") %>% 
  filter(date <= "2020-04-21") %>%
  filter(date >= "2020-02-15") %>%
  select(date, total_cases, total_deaths) %>% 
  mutate(days = c(1:67))
italy[45:67,] <- NA


ggplot() +
  geom_point(aes(x = date, y = total_cases), data = italy)
#+ geom_smooth(aes(x = date, y = total_cases), data=italy)
```

## Plot of Fatalities

```{r, echo=FALSE, message=FALSE, warning=FALSE}
ggplot() +
  geom_point(aes(x = date, y = total_deaths), data = italy)
#+ geom_smooth(aes(x = date, y = total_deaths), data=italy)
```

## Plot of Diagnosed Positive Cases with Gauss Error Function

```{r, echo=FALSE, message=FALSE, warning=FALSE}
x <- 1:67
ggplot(italy,aes(x)) +
  geom_point(aes(x = days, y = total_cases)) +
  stat_function(fun=function(x) 100000 + 100000 * erf(0.07*x - 3))
```

## Plot of Fatalities with Gauss Error Function

```{r, echo=FALSE, message=FALSE, warning=FALSE}
ggplot(italy,aes(x)) +
  geom_point(aes(x = days, y = total_deaths)) +
  stat_function(fun=function(x) 11000 + 11000 * erf(0.068*x - 3))
```

# Australia Simulation

## Australia Simulation
```{r, results=FALSE, echo=FALSE, message=FALSE, warning=FALSE}
library(tidyverse)
library(dplyr)
library(pracma)
data <- read_csv("owid-covid-data.csv")
australia <- data %>% filter(location == "Australia", date > "2020-06-01", date < "2020-12-19")
australia <- subset(australia, select = c(date, total_cases, total_deaths))
australia <- australia %>% mutate(days = 1:n())
minimizedDays <- 70
australiaPre <- australia %>% filter(days < minimizedDays)
cases_Australia <- ggplot(australiaPre, aes(x = date, y = total_cases)) + 
    geom_line() + 
    labs(title = "Total Cases in Australia from 6/1/2020 to 8/9/2020 (70 days)", x = "Date", y = "Total Cases")
fatalities_Australia <- ggplot(australiaPre, aes(x = date, y = total_deaths)) +
    geom_line() + 
    labs(title = "Total Deaths in Australia from 6/1/2020 to 8/9/2020 (70 days)", x = "Date", y = "Total Deaths")
x <- 0:minimizedDays
cases_function_australia <- function(x) 17200+10000*erf(0.04*x-2.4)
fatalities_function_australia <- function(x) 500+400*erf(0.038*x-3.1)
cases_pre_plot_Australia <- ggplot(australiaPre, aes(x = days, y = total_cases)) + 
    geom_line() + 
    stat_function(fun=cases_function_australia, color="#d33636", size=2, linetype="dotted") +
    scale_x_continuous(breaks = seq(0, minimizedDays, 1)) +
    labs(title = "Total Cases in Australia from 6/1/2020 to 8/9/2020 (70 days)", x = "Days", y = "Total Cases")
fatalities_pre_plot_Australia <- ggplot(australiaPre, aes(x = days, y = total_deaths)) +
    geom_line() + 
    stat_function(fun=fatalities_function_australia, color="#3333e2", size=2, linetype="dotted") +
    scale_x_continuous(breaks = seq(0, minimizedDays, 1)) +
    labs(title = "Total Deaths in Australia from 6/1/2020 to 8/9/2020 (70 days)", x = "Days", y = "Total Deaths")
x <- 0:200
cases_function_australia <- function(x) 17200+10000*erf(0.04*x-2.4)
fatalities_function_australia <- function(x) 500+400*erf(0.038*x-3.1)
cases_plot_Australia <- ggplot(australia, aes(x = days, y = total_cases)) + 
    geom_line() + 
    stat_function(fun=cases_function_australia, color="#d33636", size=1.5) +
    scale_x_continuous(breaks = seq(0, 200, 1)) +
    labs(title = "Total Cases in Australia from 6/1/2020 to 12/18/2020 (200 days)", x = "Days", y = "Total Cases")
fatalities_plot_Australia <- ggplot(australia, aes(x = days, y = total_deaths)) +
    geom_line() + 
    stat_function(fun=fatalities_function_australia, color="#3333e2", size=1.5) +
    scale_x_continuous(breaks = seq(0, 200, 1)) +
    labs(title = "Total Deaths in Australia from 6/1/2020 to 12/18/2020 (200 days)", x = "Days", y = "Total Deaths")
```
```{r, echo=FALSE}
# print(cases_Australia)
# print(fatalities_Australia)
print(cases_pre_plot_Australia)
# print(fatalities_pre_plot_Australia)
# cases_plot_Australia
# print(fatalities_plot_Australia)
```

## Australia results

```{r, echo=FALSE}
# print(cases_Australia)
# print(fatalities_Australia)
# print(cases_pre_plot_Australia)
# print(fatalities_pre_plot_Australia)
cases_plot_Australia
# print(fatalities_plot_Australia)
```

# Monte Carlo Simulations

## China

## Italy

## Australia

## Works Cited
- Link to study:
- I. Ciufolini, A. Paolozzi, Prediction of the time evolution of the Covid-19 Pandemic in Italy by a Gauss
Error Function and Monte Carlo simulations. Submitted to BioRxiv on 03.26.2020 and transferred on
03.27.2020 to MedRxiv. https://doi.org/10.1101/2020.03.27.20045104
- Link to covid data:
- https://covid19.who.int/
- source to find the second derivative of fitted function:
- https://proofwiki.org/wiki/Derivative_of_Error_Function