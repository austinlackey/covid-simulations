---
title: "MonteCarlo Simulation's of the Covid-19 Pandemic"
author: "Austin Lackey, Chien Lin and Jin Peng"
date: "Tuesday, December 6th, 2022"
output: 
  pdf_document:
    toc: TRUE
    toc_depth: 2
    number_sections: TRUE
    df_print: paged
    fig_caption: TRUE
    highlight: tango
---
```{r setup, include=FALSE}
# useful libraries
library(tidyverse)
library(pracma)
library(minpack.lm)
# read covid data
data <- read_csv("owid-covid-data.csv")
set.seed(420)
knitr::opts_chunk$set(fig.width=3, fig.height=3) 
```

# Introduction (Should we do an Abstract?)

## Background

In our MonteCarlo simulation analysis, we fit a gauss-error function over cumulaative Covid-19 data.
In the study mentioned below, the authors stated that it is widely accepted that China's Covid-19 data follows a gauss-error function. 
We decided to test this hypothesis by fitting a gauss-error function over the data of China, Italy, and the United States using data from the World Health Organization (WHO).
We then used the fitted function to predict the time evolution of the Covid-19 Pandemic in each country.
For context to our project, time evolution is the rate of change of the number of cases over time.
By fitting a gauss-error function to partial data, we are able to prefict the day of flex point for that given country. 
Our primary motivation for this project is to see if the gauss-error function is a good fit for various different countries.


## Ciufolini and Paolozzi's MonteCarlo Study

Our project is an extension and replication of the study done by Ciufolini and Paolozzi. 
*"Mathematical prediction of the time evolution of the COVID-19 pandemic in Italy by a Gauss error function and Monte Carlo simulations"*. 
The authors of this study used a MonteCarlo simulation to fit a gauss-error function over the data of China and extending it to Italy.
In their study, it was widely accepted that China's Covid-19 data follows a gauss-error function.  

$$Gauss-Error Function =a+b*erf(c*x-d)$$

The authors perfomed a MonteCarlo simulation with 150 replications to approximate the day of flex point for China and Italy.
The use of the MonteCarlo simulation was crucial to their study's success as reported cases and fatalities can differ up `to 10%` from the actual number of cases and fatalities.




# Jin: China

*Insert text here*

# Chien: Italy

*Insert text here*

# Austin: Australia

## Fitting a Gauss-Error Function to Australia's Data

We wanted to extend the findings from the study done by Ciufolini and Paolozzi to other countries.
The first country that we decided to test was Australia.
Since we have access to all of Australia's data at the time of writing this report, we decided to test the gauss-error function on a subset timeframe of the entire dataset.
To begin, we limited our data to the timeframe of 6/2/2020 to 8/9/2020 which is 70 days.
As you can see in Figure A and Figure B, the data begins to follow a gauss-error function shape.
The days on the x-axis are the number of days following 6/2/2020.

```{r, results=FALSE, echo=FALSE, message=FALSE, warning=FALSE}
australia <- data %>% filter(location == "Australia", date > "2020-06-01", date < "2020-12-19")
australia <- subset(australia, select = c(date, total_cases, total_deaths))
australia <- australia %>% mutate(days = 1:n())
minimizedDays <- 70
australiaPre <- australia %>% filter(days < minimizedDays)
cases_Australia <- ggplot(australiaPre, aes(x = days, y = total_cases)) + 
    geom_point() + 
    theme(title =element_text(size=6)) + 
    labs(title = "Figure A: Total Cases in Australia from 6/2/2020 to 8/9/2020 (70 days)", x = "Days", y = "Total Cases")
fatalities_Australia <- ggplot(australiaPre, aes(x = days, y = total_deaths)) +
    geom_point() + 
    theme(title =element_text(size=6)) + 
    labs(title = "Figure B: Total Deaths in Australia from 6/2/2020 to 8/9/2020 (70 days)", x = "Days", y = "Total Deaths")
```

```{r, echo=FALSE, message=FALSE, warning=FALSE}
print(cases_Australia)
print(fatalities_Australia)
```


In order to fit a gauss-error function to the data, we used the `nlsLM` function from the `minpack.lm` library.
This allows us to fit a gauss-error function to the data and find the parameters of the function.
As you can see in Figures C and D, the fitted function follows the data very well.
One important distinction to note is that the fatalities begin to follow the gauss-error function shape at a later time than the cases.
This makes sense as death rates begin to increase after the number of cases begin to increase.

```{r, results=FALSE, echo=FALSE, message=FALSE, warning=FALSE}
x <- 0:minimizedDays


gauss_fn <- function(x,a,b,c,d) {a+b*erf(c*x-d)}
cf <- summary(nlsLM(total_cases ~ gauss_fn(days,a,b,c,d), data=australia, start=list(a=10000,b=500,c=.02,d=1)))$parameters
ff <- summary(nlsLM(total_deaths ~ gauss_fn(days,a,b,c,d), data=australia, start=list(a=100,b=100,c=.01,d=1)))$parameters


cases_function_australia <- function(x) cf[1]+cf[2]*erf(cf[3]*x-cf[4])
fatalities_function_australia <- function(x) ff[1]+ff[2]*erf(ff[3]*x-ff[4])


cases_pre_plot_Australia <- ggplot(australiaPre, aes(x = days, y = total_cases)) + 
    geom_point() + 
    theme(title =element_text(size=6)) + 
    stat_function(fun=cases_function_australia, color="#d33636", size=2, linetype="solid") +
    scale_x_continuous(breaks = seq(0, minimizedDays, 10)) +
    labs(title = "Figure C: Total Cases in Australia from 6/2/2020 to 8/9/2020 (70 days)", x = "Days", y = "Total Cases")
fatalities_pre_plot_Australia <- ggplot(australiaPre, aes(x = days, y = total_deaths)) +
    geom_point() + 
    theme(title =element_text(size=6)) + 
    stat_function(fun=fatalities_function_australia, color="#1b95ff", size=2, linetype="solid") +
    scale_x_continuous(breaks = seq(0, minimizedDays, 10)) +
    labs(title = "Figure D: Total Deaths in Australia from 6/2/2020 to 8/9/2020 (70 days)", x = "Days", y = "Total Deaths")
```

```{r, echo=FALSE, message=FALSE, warning=FALSE}
print(cases_pre_plot_Australia)
print(fatalities_pre_plot_Australia)
```

## Extrapolating the Gauss-Error Function to Australia's Future Data

Once we have a fitted gauss-error function, we can extrapolate the function to the future.
We decided to extrapolate the function to 200 days which is an increase from China's and Italy's extrapolation. 
The reasoning for this increase is that it takes longer for the number of cases to increase in Australia than it does in China and Italy.
We are not quite sure why this is the case, but we believe it is due to the fact that Australia had different restrictions in place than China and Italy.
As you can see in Figures E and F, the extrapolated function starts to show us an idea of what the future of Australia's data could look like if the current trend continues.
The first thing we noticed was that the cases were getting close to their expected plateau and the fatalities were just beggining to increase.

```{r, results=FALSE, echo=FALSE, message=FALSE, warning=FALSE}
x <- 0:200

# cases_function_australia <- function(x) 17200+10000*erf(0.04*x-2.4)
# fatalities_function_australia <- function(x) 500+400*erf(0.038*x-3.1)

cases_plot_Australia <- ggplot(australia, aes(x = days, y = total_cases)) + 
    geom_point() + 
    theme(title =element_text(size=6)) + 
    stat_function(fun=cases_function_australia, color="#d33636", size=1.5) +
    scale_x_continuous(breaks = seq(0, 200, 10)) +
    labs(title = "Total Cases in Australia from 6/2/2020 to 12/18/2020 (200 days)", x = "Days", y = "Total Cases")
fatalities_plot_Australia <- ggplot(australia, aes(x = days, y = total_deaths)) +
    geom_point() + 
    theme(title =element_text(size=6)) +
    stat_function(fun=fatalities_function_australia, color="#1b95ff", size=1.5) +
    scale_x_continuous(breaks = seq(0, 200, 10)) +
    labs(title = "Total Deaths in Australia from 6/2/2020 to 12/18/2020 (200 days)", x = "Days", y = "Total Deaths")
```

```{r, results=FALSE, echo=FALSE, message=FALSE, warning=FALSE}
cases_plot_Australia_future <- ggplot(australiaPre, aes(x = days, y = total_cases)) + 
    geom_point() + 
    theme(title =element_text(size=6)) + 
    stat_function(fun=cases_function_australia, color="#d33636", size=1.5) +
    scale_x_continuous(breaks = seq(0, 200, 10)) +
    xlim(0, 200) +
    labs(title = "Figure E: Extrapolating Future Case Data with Gauss Error Function", x = "Days", y = "Total Cases")
fatalities_plot_Australia_future <- ggplot(australiaPre, aes(x = days, y = total_deaths)) +
    geom_point() + 
    theme(title =element_text(size=6)) +
    stat_function(fun=fatalities_function_australia, color="#1b95ff", size=1.5) +
    scale_x_continuous(breaks = seq(0, 200, 10)) +
    xlim(0, 200) +
    labs(title = "Figure F: Extrapolating Future Fatality Data with Gauss Error Function", x = "Days", y = "Total Deaths")
```

```{r, echo=FALSE, message=FALSE, warning=FALSE}
print(cases_plot_Australia_future)
print(fatalities_plot_Australia_future)
```

## MonteCarlo Simulation for Australia's Day of Flex

```{r, results=FALSE, echo=FALSE, message=FALSE, warning=FALSE}
#Montecarlo Simulation
set.seed(400)
n <- dim(australia)[1]
m <- 150
sigma <- 0.1
mu <- 1
gau_sample <- matrix(rnorm(n*m, mean=mu, sd=sigma), nrow = m, ncol = n)

mc_data_ca <- c()
for (i in 1:n) {
    mc_data_ca <- c(mc_data_ca, australia$total_cases[i]*gau_sample[,i])
}
mc_data_ca <- matrix(mc_data_ca, nrow = m, ncol = n)
mc_data_fa <- c()
for (i in 1:n) {
    mc_data_fa <- c(mc_data_fa, australia$total_deaths[i]*gau_sample[,i])
}
mc_data_fa <- matrix(mc_data_fa, nrow = m, ncol = n)

day_of_flex_ca <- rep(NA, m)
for (i in 1:m) {
    trial <- mc_data_ca[i,]
    trial_model <- nlsLM(trial ~ gauss_fn(days,a,b,c,d), data=australia, start=list(a=15000,b=9000,c=.01,d=1))
    model_coef <- summary(trial_model)$parameters[, 1]
    # trial_function <- function(x, coef) {coef[1] + coef[2]*erf(coef[3]*x-coef[4])}
    gauserr_derivative <- {2/sqrt(pi)*exp(-x^2)}
    function_trial_derivative <- D(bquote(.(model_coef[2])*2/sqrt(pi)*exp(-(.(model_coef[3])*x-.(model_coef[4]))^2)), 'x')
    x = seq(1, 200, length.out=6700)
    temp <- eval(function_trial_derivative)
    day_of_flex_ca[i] <- min(x[temp < 0])
}
```

```{r, results=FALSE, echo=FALSE, message=FALSE, warning=FALSE}
day_of_flex_fa <- rep(NA, m)
for (i in 1:m) {
    trial <- mc_data_fa[i,]
    trial_model <- nlsLM(trial ~ gauss_fn(days,a,b,c,d), data=australia, start=list(a=300,b=200,c=.01,d=1))
    model_coef <- summary(trial_model)$parameters[, 1]
    # trial_function <- function(x, coef) {coef[1] + coef[2]*erf(coef[3]*x-coef[4])}
    gauserr_derivative <- {2/sqrt(pi)*exp(-x^2)}
    function_trial_derivative <- D(bquote(.(model_coef[2])*2/sqrt(pi)*exp(-(.(model_coef[3])*x-.(model_coef[4]))^2)), 'x')
    x = seq(1, 200, length.out=6700)
    temp <- eval(function_trial_derivative)
    day_of_flex_fa[i] <- min(x[temp < 0])
}
```

In order to account for the `10%` variance in the reported data, we need to run a MonteCarlo simulation.
We decided to run a MonteCarlo simulation with a `150` iterations and a `0.1` standard deviation.
The reason we chose a `150` iterations is because we wanted to have a large enough sample size to get a good idea of the variance in the data.
This was also the same values that Ciufolini and Paolozzi used in their paper.
As you can see in Figures G and H, the MonteCarlo simulation shows us that the variance in the data is not as large as it was for China and Italy.
We believe this is due to the fact that since Australia required more days to reach their peak, the variance in the data is smaller since `n` is much larger.
The day of flex for cases in Australia appears to reside around `r round(mean(day_of_flex_ca), 2)` days with a standard deviation of `r round(sd(day_of_flex_ca), 2)` days.
The day of flex for fatalities in Australia appears to reside around `r round(mean(day_of_flex_fa), 2)` days with a standard deviation of `r round(sd(day_of_flex_fa), 2)` days.

```{r, results=FALSE, echo=FALSE, message=FALSE, warning=FALSE}
australiaMCPlot_cases <- ggplot() +
    geom_point(aes(x=1:m, y=day_of_flex_ca), color="#d33636") +
    theme(title =element_text(size=6)) + 
    geom_hline(yintercept=mean(day_of_flex_ca), color="#d33636", linetype="dashed", size=2) + 
    labs(title = "Figure G: MonteCarlo Simulation for Day of Flex (Cases)", x = "Trial", y = "Day of Flex")
australiaMCPlot_fatalities <- ggplot() +
    geom_point(aes(x=1:m, y=day_of_flex_fa), color="#1b95ff") +
    theme(title =element_text(size=6)) +
    geom_hline(yintercept=mean(day_of_flex_fa), color="#1b95ff", linetype="dashed", size=2) + 
    labs(title = "Figure G: MonteCarlo Simulation for Day of Flex (Fatalities)", x = "Trial", y = "Day of Flex")
```

```{r, echo=FALSE, message=FALSE, warning=FALSE}
print(australiaMCPlot_cases)
print(australiaMCPlot_fatalities)
```

## Applying the day of flex indicator to the data

As you can see in Figures I and J, the day of flex indicator for cases and fatalities appears to sit right on the midpoint of the projected gauss-curve.
This is because the day of flex indicator is the point at which the derivative of the gauss-curve is equal to `0`.
This is when the daily cases and fatalities are at their peak and begin to decline.

```{r, echo=FALSE, message=FALSE, warning=FALSE}
print(cases_plot_Australia_future + 
  geom_vline(xintercept = mean(day_of_flex_ca), color="#d33636", size=1.5, linetype="dashed") + 
  labs(title="Figure I: Day of flex indicator for cases (60 days after)") + 
  theme(title =element_text(size=6)))
print(fatalities_plot_Australia_future + 
  geom_vline(xintercept = mean(day_of_flex_fa), color="#1b95ff", size=1.5, linetype="dashed") + 
  labs(title="Figure J: Day of flex indicator for fatalities (81 days after)") + 
  theme(title =element_text(size=6)))
```

## Confirming Results with entire dataset

In order to confirm our results, we decided to overlay our findings with the entire dataset to see how well our model fits the actual data.
As you can see in Figures K and L, our model did a decent job of fitting the actual data.
It appears the model works the best for fatalities but the cases model starts to be a little innacurate once the data starts to plateau.
Our theory for this inconsistency between fatalities and cases is that it is far easier to report fatalities than it is to report cases.
It is not often that a person will die from the virus and not be tested or reported.
However, it is very common for a person to have the virus and not be reported.
This variance in the data once it begins to plateau could be due to the fact that testing procedures could have changed or the reporting procedures could have changed.
Since the curve starts to overestimate and then starts to underestimate, Australia could have had a few weeks where they were not doing as much testing, and then they started doing more testing.
This could explain the variance in the tail of the data.
Regardless of this variance, our model did a good job at predicting and fitting the day of flex.

```{r, echo=FALSE, message=FALSE, warning=FALSE, results=FALSE}
cases_plot_Australia_confirm <- ggplot(australia, aes(x = days, y = total_cases)) + 
    geom_point() + 
    theme(title =element_text(size=6)) + 
    stat_function(fun=cases_function_australia, color="#d33636", size=1.5) +
    scale_x_continuous(breaks = seq(0, 200, 10)) +
    geom_vline(xintercept = mean(day_of_flex_ca), color="#d33636", size=1.5, linetype="dashed") +
    labs(title = "Figure K: Entire Cases in Australia from 6/2/2020 to 12/18/2020 (200 days)", x = "Days", y = "Total Cases")
fatalities_plot_Australia_confirm <- ggplot(australia, aes(x = days, y = total_deaths)) +
    geom_point() + 
    theme(title =element_text(size=6)) +
    stat_function(fun=fatalities_function_australia, color="#1b95ff", size=1.5) +
    scale_x_continuous(breaks = seq(0, 200, 10)) +
    geom_vline(xintercept = mean(day_of_flex_fa), color="#1b95ff", size=1.5, linetype="dashed") + 
    labs(title = "Figure L: Entire Fatalities in Australia from 6/2/2020 to 12/18/2020 (200 days)", x = "Days", y = "Total Deaths")
```

```{r, echo=FALSE, message=FALSE, warning=FALSE}
print(cases_plot_Australia_confirm)
print(fatalities_plot_Australia_confirm)
```

# United States Anomaly

An interesting anomaly that we found in the data was that the United States had a hard time fitting the gauss-error funciton.
As you can see in Figures M and N, the United States data does not ever begin to plateau. 
The data is always at an increasing rate.
This makes it hard to predict when the day of flex will be.
We believe that this is due to the fact that the United States had very lax restrictions when compared to other countries.

```{r, echo=FALSE, message=FALSE, warning=FALSE, results=FALSE}
# US data
us <- data %>% filter(location == "United States")
us <- subset(us, select = c(date, total_cases, total_deaths))
us <- us %>% mutate(days = 1:n())
us <- us %>% mutate(year = substr(date, 1, 4))
us_data_cases <- ggplot(data=us, aes(x=days, y=total_cases, color=year)) + 
  geom_point() + 
  labs(title="Figure M: Total Cases in the United States from 1/22/2020 to 11/14/2022 (1,028 days)", color="Year", x="Days", y="Total Cases")
us_data_deaths <- ggplot(data=us, aes(x=days, y=total_deaths, color=year)) + 
  geom_point() + 
  labs(title="Figure N: Total Deaths in the United States from 1/22/2020 to 11/14/2022 (1,028 days)", color="Year", x="Days", y="Total Deaths")
```

```{r, echo=FALSE, message=FALSE, warning=FALSE}
print(us_data_cases)
print(us_data_deaths)
```







# Simulation Analysis Summary

In our simulation analysis, we found that the day of flex indicator was a good predictor of when the day of flex would be for most countries.
This model may not be the best model for countries who have different restrictions or have different testing procedures.


# Potential Improvements

One idea that comes to mind in terms of improvements for this model is to see if we can account for the changes in testing procedures. 
This could be done by looking at the data and seeing when the testing procedures changed and then adjusting the model to account for this change.
Although this would require advanced knowledge of the data as well as policy changes, but it could be a good way to improve the model.
Another idea is to see if we could find other models that fit countries with laxer restrictions better.
If they don't follow a gauss-error function, then we could try to explore other models that fit their data better.

# Works Cited

- Link to the study:
  - I. Ciufolini, A. Paolozzi, Prediction of the time evolution of the Covid-19 Pandemic in Italy by a Gauss
Error Function and Monte Carlo simulations. Submitted to BioRxiv on 03.26.2020 and transferred on
03.27.2020 to MedRxiv. https://doi.org/10.1101/2020.03.27.20045104
- Link to the covid data used:
  - https://covid19.who.int/
- Source to find the second derivative of fitted function:
  - https://proofwiki.org/wiki/Derivative_of_Error_Function